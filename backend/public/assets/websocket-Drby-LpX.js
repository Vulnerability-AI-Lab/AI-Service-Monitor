import{X as H,k as f}from"./index-D53lTjIk.js";import{u as L}from"./servers-CvzP1gNB.js";const J=H("websocket",()=>{const s=f(null),i=f(!1),d=f(!1),S=f(0),b=10,w=3e3,u=new Map;function y(){const e=localStorage.getItem("token");if(!e)return;const t=window.location.protocol==="https:"?"wss:":"ws:",o=window.location.hostname,r=8001;s.value=new WebSocket(`${t}//${o}:${r}`),s.value.onopen=()=>{console.log("WebSocket connected"),i.value=!0,S.value=0,n({type:"auth",payload:{token:e}})},s.value.onmessage=c=>{try{const a=JSON.parse(c.data);E(a)}catch(a){console.error("Failed to parse WebSocket message:",a)}},s.value.onclose=()=>{console.log("WebSocket disconnected"),i.value=!1,d.value=!1,S.value<b&&(S.value++,setTimeout(y,w))},s.value.onerror=c=>{console.error("WebSocket error:",c)}}function _(){s.value&&(s.value.close(),s.value=null),i.value=!1,d.value=!1}function n(e){var t;((t=s.value)==null?void 0:t.readyState)===WebSocket.OPEN&&s.value.send(JSON.stringify(e))}function E(e){const{type:t,payload:o}=e,r=L();switch(t){case"auth_success":d.value=!0,n({type:"subscribe",payload:{channel:"status",serverIds:[]}});break;case"auth_error":console.error("WebSocket auth error:",o.message),d.value=!1;break;case"status_update":r.updateServerStatus(o);break;case"ssh_connected":break;case"ssh_output":const c=u.get(o.sessionId);c&&c.onData(o.data);break;case"ssh_close":const a=u.get(o.sessionId);a&&(a.onClose(),u.delete(o.sessionId));break;case"ssh_error":const l=u.get(o.sessionId);l&&l.onError(o.message);break;case"pong":break;default:console.log("Unknown message type:",t)}}function I(e,t,o,r){return new Promise((c,a)=>{var g;const l=v=>{var h,k;const p=JSON.parse(v.data);if(p.type==="ssh_connected"&&p.payload.serverId===e){const m=p.payload.sessionId;u.set(m,{onData:r.onData,onClose:r.onClose,onError:r.onError}),r.onConnected(m),(h=s.value)==null||h.removeEventListener("message",l),c(m)}else p.type==="ssh_error"&&((k=s.value)==null||k.removeEventListener("message",l),a(new Error(p.payload.message)))};(g=s.value)==null||g.addEventListener("message",l),n({type:"ssh_connect",payload:{serverId:e,cols:t,rows:o}}),setTimeout(()=>{var v;(v=s.value)==null||v.removeEventListener("message",l),a(new Error("连接超时"))},15e3)})}function C(e,t){n({type:"ssh_input",payload:{sessionId:e,data:t}})}function W(e,t,o){n({type:"ssh_resize",payload:{sessionId:e,cols:t,rows:o}})}function D(e){n({type:"ssh_close",payload:{sessionId:e}}),u.delete(e)}return setInterval(()=>{i.value&&n({type:"ping"})},3e4),{ws:s,connected:i,authenticated:d,connect:y,disconnect:_,send:n,connectSSH:I,sendSSHInput:C,resizeSSH:W,closeSSH:D}});export{J as u};
